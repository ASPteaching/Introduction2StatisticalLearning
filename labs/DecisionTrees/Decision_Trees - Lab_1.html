<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-04-21">

<title>Decision Trees Lab 1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="Decision_Trees - Lab_1_files/libs/clipboard/clipboard.min.js"></script>
<script src="Decision_Trees - Lab_1_files/libs/quarto-html/quarto.js"></script>
<script src="Decision_Trees - Lab_1_files/libs/quarto-html/popper.min.js"></script>
<script src="Decision_Trees - Lab_1_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Decision_Trees - Lab_1_files/libs/quarto-html/anchor.min.js"></script>
<link href="Decision_Trees - Lab_1_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Decision_Trees - Lab_1_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Decision_Trees - Lab_1_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Decision_Trees - Lab_1_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Decision_Trees - Lab_1_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#classification-trees-predicting-car-sales" id="toc-classification-trees-predicting-car-sales" class="nav-link active" data-scroll-target="#classification-trees-predicting-car-sales">Classification Trees: Predicting car sales</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#data-description" id="toc-data-description" class="nav-link" data-scroll-target="#data-description">Data description</a>
  <ul class="collapse">
  <li><a href="#data-summarization" id="toc-data-summarization" class="nav-link" data-scroll-target="#data-summarization">Data summarization</a></li>
  </ul></li>
  <li><a href="#preprocess" id="toc-preprocess" class="nav-link" data-scroll-target="#preprocess">Preprocess</a></li>
  <li><a href="#traintest-partition-of-data" id="toc-traintest-partition-of-data" class="nav-link" data-scroll-target="#traintest-partition-of-data">Train/Test partition of data</a></li>
  <li><a href="#train-model" id="toc-train-model" class="nav-link" data-scroll-target="#train-model">Train model</a></li>
  <li><a href="#plot-the-tree" id="toc-plot-the-tree" class="nav-link" data-scroll-target="#plot-the-tree">Plot the Tree</a></li>
  <li><a href="#prediction" id="toc-prediction" class="nav-link" data-scroll-target="#prediction">Prediction</a></li>
  <li><a href="#pruning-the-tree-tunning-model" id="toc-pruning-the-tree-tunning-model" class="nav-link" data-scroll-target="#pruning-the-tree-tunning-model">Pruning the tree (Tunning model)</a></li>
  <li><a href="#predicting-car-sales-with-regression-trees" id="toc-predicting-car-sales-with-regression-trees" class="nav-link" data-scroll-target="#predicting-car-sales-with-regression-trees">Predicting car sales with <em>regression</em> trees</a></li>
  </ul></li>
  <li><a href="#regression-trees-predicting-numerical-response-variables" id="toc-regression-trees-predicting-numerical-response-variables" class="nav-link" data-scroll-target="#regression-trees-predicting-numerical-response-variables">Regression Trees: Predicting numerical (response) variables</a>
  <ul class="collapse">
  <li><a href="#the-car-sales-problem-again" id="toc-the-car-sales-problem-again" class="nav-link" data-scroll-target="#the-car-sales-problem-again">The Car Sales problem (again)</a>
  <ul class="collapse">
  <li><a href="#get-the-data" id="toc-get-the-data" class="nav-link" data-scroll-target="#get-the-data">Get the Data</a></li>
  <li><a href="#create-tarintest-sets" id="toc-create-tarintest-sets" class="nav-link" data-scroll-target="#create-tarintest-sets">Create tarin/test sets</a></li>
  <li><a href="#build-and-check-the-model" id="toc-build-and-check-the-model" class="nav-link" data-scroll-target="#build-and-check-the-model">Build (and check) the model</a></li>
  <li><a href="#make-prediction" id="toc-make-prediction" class="nav-link" data-scroll-target="#make-prediction">Make prediction</a></li>
  <li><a href="#estimate-prediction-error" id="toc-estimate-prediction-error" class="nav-link" data-scroll-target="#estimate-prediction-error">Estimate prediction error</a></li>
  <li><a href="#optimize-the-tree" id="toc-optimize-the-tree" class="nav-link" data-scroll-target="#optimize-the-tree">Optimize the tree</a></li>
  </ul></li>
  <li><a href="#predicting-boston-house-prices" id="toc-predicting-boston-house-prices" class="nav-link" data-scroll-target="#predicting-boston-house-prices">Predicting Boston house prices</a>
  <ul class="collapse">
  <li><a href="#model-fitting" id="toc-model-fitting" class="nav-link" data-scroll-target="#model-fitting">Model fitting</a></li>
  <li><a href="#prunning-the-tree" id="toc-prunning-the-tree" class="nav-link" data-scroll-target="#prunning-the-tree">Prunning the tree</a></li>
  <li><a href="#predicting-and-checking-model-accuracy" id="toc-predicting-and-checking-model-accuracy" class="nav-link" data-scroll-target="#predicting-and-checking-model-accuracy">Predicting and checking model accuracy</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#alternative-packages-for-cart" id="toc-alternative-packages-for-cart" class="nav-link" data-scroll-target="#alternative-packages-for-cart">Alternative packages for CART</a>
  <ul class="collapse">
  <li><a href="#comparison-between-caret-rpart-and-tree" id="toc-comparison-between-caret-rpart-and-tree" class="nav-link" data-scroll-target="#comparison-between-caret-rpart-and-tree">Comparison between <code>caret</code>, <code>rpart</code>, and <code>tree</code></a>
  <ul class="collapse">
  <li><a href="#table-comparison-of-important-functions-for-working-with-decision-trees" id="toc-table-comparison-of-important-functions-for-working-with-decision-trees" class="nav-link" data-scroll-target="#table-comparison-of-important-functions-for-working-with-decision-trees">Table: Comparison of important functions for working with decision trees</a></li>
  <li><a href="#examples-of-usage" id="toc-examples-of-usage" class="nav-link" data-scroll-target="#examples-of-usage">Examples of usage:</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="Decision_Trees---Lab_1.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Decision Trees Lab 1</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Adapted by EVL, FRC and ASP </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 21, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="classification-trees-predicting-car-sales" class="level1">
<h1>Classification Trees: Predicting car sales</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This example has been adapted from the book “Introduction to Statistical Learning with R”, <a href="https://hastie.su.domains/ISLR2/Labs/Rmarkdown_Notebooks/Ch8-baggboost-lab.Rmd">lab 8.3</a>.</p>
<p>The authors have decided to use the R <code>tree</code> package, which is not the most powerful R package for trees, but offers a good compromise between power and flexibility.</p>
<p>The lab relies on the <code>Carseats</code> dataset, a simulated dataset, that is included with the book’s package, containing several variables about sales of child car seats at different stores.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ISLR2)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Carseats"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">help</span>(<span class="st">"Carseats"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>A data frame with 400 observations on the following 11 variables.</p>
<ul>
<li><code>Sales</code>: Unit sales (in thousands) at each location</li>
<li><code>CompPrice</code>: Price charged by competitor at each location</li>
<li><code>Income</code>: Community income level (in thousands of dollars)</li>
<li><code>Advertising</code>: Local advertising budget for company at each location (in thousands of dollars)</li>
<li><code>Population</code>: Population size in region (in thousands)</li>
<li><code>Price</code>: Price company charges for car seats at each site</li>
<li><code>ShelveLoc</code>: A factor with levels Bad, Good and Medium indicating the quality of the shelving location for the car seats at each site</li>
<li><code>Age</code>: Average age of the local population</li>
<li><code>Education</code>: Education level at each location</li>
<li><code>Urban</code>: A factor with levels No and Yes to indicate whether the store is in an urban or rural location</li>
<li><code>US</code>: A factor with levels No and Yes to indicate whether the store is in the US or not</li>
</ul>
<p>The first part of the lab will aim at predicting the variable <code>sales</code>.</p>
<p>In order to apply classification trees first, we start by categorizing the <code>sales</code>variable. <em>This is not usually seen as a good strategy, so take it only for didactical purpose</em>.</p>
</section>
<section id="data-description" class="level2">
<h2 class="anchored" data-anchor-id="data-description">Data description</h2>
<p>We use a generic name for the dataset, in order to facilitate code reuse.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>myDescription <span class="ot">&lt;-</span> <span class="st">"The data are a simulated data set containing sales of child car seats at different stores [@james2013introduction]"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>mydataset <span class="ot">&lt;-</span> Carseats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(mydataset)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(mydataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>There are <code>400</code> rows and <code>11</code> columns.</p>
<p>The variable <code>Sales</code> is categorized creating a new variable, <code>High</code>, which takes on a value of <code>Yes</code> if the <code>Sales</code> variable exceeds 8, and a value of <code>No</code> otherwise.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># as.factor() changes the type of variable to factor</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>mydataset<span class="sc">$</span>High<span class="ot">=</span><span class="fu">as.factor</span>(<span class="fu">ifelse</span>(mydataset<span class="sc">$</span>Sales<span class="sc">&lt;=</span><span class="dv">8</span>,<span class="st">"No"</span>,<span class="st">"Yes"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The number of observations for each class is:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">table</span>(mydataset<span class="sc">$</span>High), <span class="at">caption=</span> <span class="st">"Number of observations for each class"</span>, <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">'High'</span>,<span class="st">'Freq'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Number of observations for each class</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">High</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">No</td>
<td style="text-align: right;">236</td>
</tr>
<tr class="even">
<td style="text-align: left;">Yes</td>
<td style="text-align: right;">164</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The aim is of this study is to predict the categorical values of sales (<code>High</code>) using all variables but <code>Sales</code>.</p>
<p>It is a classification problem and we will build a <em>classification tree model</em>.</p>
<section id="data-summarization" class="level3">
<h3 class="anchored" data-anchor-id="data-summarization">Data summarization</h3>
<p>This is a short data set summary</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mydataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     Sales          CompPrice       Income        Advertising    
 Min.   : 0.000   Min.   : 77   Min.   : 21.00   Min.   : 0.000  
 1st Qu.: 5.390   1st Qu.:115   1st Qu.: 42.75   1st Qu.: 0.000  
 Median : 7.490   Median :125   Median : 69.00   Median : 5.000  
 Mean   : 7.496   Mean   :125   Mean   : 68.66   Mean   : 6.635  
 3rd Qu.: 9.320   3rd Qu.:135   3rd Qu.: 91.00   3rd Qu.:12.000  
 Max.   :16.270   Max.   :175   Max.   :120.00   Max.   :29.000  
   Population        Price        ShelveLoc        Age          Education   
 Min.   : 10.0   Min.   : 24.0   Bad   : 96   Min.   :25.00   Min.   :10.0  
 1st Qu.:139.0   1st Qu.:100.0   Good  : 85   1st Qu.:39.75   1st Qu.:12.0  
 Median :272.0   Median :117.0   Medium:219   Median :54.50   Median :14.0  
 Mean   :264.8   Mean   :115.8                Mean   :53.32   Mean   :13.9  
 3rd Qu.:398.5   3rd Qu.:131.0                3rd Qu.:66.00   3rd Qu.:16.0  
 Max.   :509.0   Max.   :191.0                Max.   :80.00   Max.   :18.0  
 Urban       US       High    
 No :118   No :142   No :236  
 Yes:282   Yes:258   Yes:164  
                              
                              
                              
                              </code></pre>
</div>
</div>
<p>An improved description:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>skimr<span class="sc">::</span><span class="fu">skim</span>(mydataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table style="width: auto;" class="table table-condensed">
<caption>
Data summary
</caption>
<tbody>
<tr>
<td style="text-align:left;">
Name
</td>
<td style="text-align:left;">
mydataset
</td>
</tr>
<tr>
<td style="text-align:left;">
Number of rows
</td>
<td style="text-align:left;">
400
</td>
</tr>
<tr>
<td style="text-align:left;">
Number of columns
</td>
<td style="text-align:left;">
12
</td>
</tr>
<tr>
<td style="text-align:left;">
_______________________
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Column type frequency:
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
factor
</td>
<td style="text-align:left;">
4
</td>
</tr>
<tr>
<td style="text-align:left;">
numeric
</td>
<td style="text-align:left;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
________________________
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Group variables
</td>
<td style="text-align:left;">
None
</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left;">
skim_variable
</th>
<th style="text-align:right;">
n_missing
</th>
<th style="text-align:right;">
complete_rate
</th>
<th style="text-align:left;">
ordered
</th>
<th style="text-align:right;">
n_unique
</th>
<th style="text-align:left;">
top_counts
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ShelveLoc
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
Med: 219, Bad: 96, Goo: 85
</td>
</tr>
<tr>
<td style="text-align:left;">
Urban
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
Yes: 282, No: 118
</td>
</tr>
<tr>
<td style="text-align:left;">
US
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
Yes: 258, No: 142
</td>
</tr>
<tr>
<td style="text-align:left;">
High
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
No: 236, Yes: 164
</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left;">
skim_variable
</th>
<th style="text-align:right;">
n_missing
</th>
<th style="text-align:right;">
complete_rate
</th>
<th style="text-align:right;">
mean
</th>
<th style="text-align:right;">
sd
</th>
<th style="text-align:right;">
p0
</th>
<th style="text-align:right;">
p25
</th>
<th style="text-align:right;">
p50
</th>
<th style="text-align:right;">
p75
</th>
<th style="text-align:right;">
p100
</th>
<th style="text-align:left;">
hist
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Sales
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
7.50
</td>
<td style="text-align:right;">
2.82
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
5.39
</td>
<td style="text-align:right;">
7.49
</td>
<td style="text-align:right;">
9.32
</td>
<td style="text-align:right;">
16.27
</td>
<td style="text-align:left;">
▁▆▇▃▁
</td>
</tr>
<tr>
<td style="text-align:left;">
CompPrice
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
124.97
</td>
<td style="text-align:right;">
15.33
</td>
<td style="text-align:right;">
77
</td>
<td style="text-align:right;">
115.00
</td>
<td style="text-align:right;">
125.00
</td>
<td style="text-align:right;">
135.00
</td>
<td style="text-align:right;">
175.00
</td>
<td style="text-align:left;">
▁▅▇▃▁
</td>
</tr>
<tr>
<td style="text-align:left;">
Income
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
68.66
</td>
<td style="text-align:right;">
27.99
</td>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
42.75
</td>
<td style="text-align:right;">
69.00
</td>
<td style="text-align:right;">
91.00
</td>
<td style="text-align:right;">
120.00
</td>
<td style="text-align:left;">
▇▆▇▆▅
</td>
</tr>
<tr>
<td style="text-align:left;">
Advertising
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6.64
</td>
<td style="text-align:right;">
6.65
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
5.00
</td>
<td style="text-align:right;">
12.00
</td>
<td style="text-align:right;">
29.00
</td>
<td style="text-align:left;">
▇▃▃▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
Population
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
264.84
</td>
<td style="text-align:right;">
147.38
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
139.00
</td>
<td style="text-align:right;">
272.00
</td>
<td style="text-align:right;">
398.50
</td>
<td style="text-align:right;">
509.00
</td>
<td style="text-align:left;">
▇▇▇▇▇
</td>
</tr>
<tr>
<td style="text-align:left;">
Price
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
115.80
</td>
<td style="text-align:right;">
23.68
</td>
<td style="text-align:right;">
24
</td>
<td style="text-align:right;">
100.00
</td>
<td style="text-align:right;">
117.00
</td>
<td style="text-align:right;">
131.00
</td>
<td style="text-align:right;">
191.00
</td>
<td style="text-align:left;">
▁▂▇▆▁
</td>
</tr>
<tr>
<td style="text-align:left;">
Age
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
53.32
</td>
<td style="text-align:right;">
16.20
</td>
<td style="text-align:right;">
25
</td>
<td style="text-align:right;">
39.75
</td>
<td style="text-align:right;">
54.50
</td>
<td style="text-align:right;">
66.00
</td>
<td style="text-align:right;">
80.00
</td>
<td style="text-align:left;">
▇▆▇▇▇
</td>
</tr>
<tr>
<td style="text-align:left;">
Education
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
13.90
</td>
<td style="text-align:right;">
2.62
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
12.00
</td>
<td style="text-align:right;">
14.00
</td>
<td style="text-align:right;">
16.00
</td>
<td style="text-align:right;">
18.00
</td>
<td style="text-align:left;">
▇▇▃▇▇
</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="preprocess" class="level2">
<h2 class="anchored" data-anchor-id="preprocess">Preprocess</h2>
<p>It is very common that the data need to be preprocessed before training the model*</p>
<p>In this case, there seem to be no missing values, no outliers and most variables are decently symmetrical, so no cleaning or preprocessing are required.</p>
</section>
<section id="traintest-partition-of-data" class="level2">
<h2 class="anchored" data-anchor-id="traintest-partition-of-data">Train/Test partition of data</h2>
<p>In order to properly evaluate the performance of a model, we must estimate the error rather than simply computing the training error.</p>
<p>With thhis aim in mind we proceed as follows:</p>
<ol type="1">
<li>split the observations into a training set and a test set,</li>
<li>build the model using the training set, and</li>
<li>evaluate its performance on the test data.</li>
</ol>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>pt <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mydataset),pt<span class="sc">*</span><span class="fu">nrow</span>(mydataset))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>mydataset.test <span class="ot">&lt;-</span> mydataset[<span class="sc">-</span>train,]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>High.test <span class="ot">&lt;-</span>  mydataset[<span class="sc">-</span>train,<span class="st">"High"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The train and tets set have 200 200 observations respectively.</p>
<p>In train data, the number of observations for each class is:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>kableExtra<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">table</span>(mydataset[train,<span class="st">"High"</span>]), <span class="at">caption=</span> <span class="st">"Train data: number of observations for each class"</span>, <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">'High'</span>,<span class="st">'Freq'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Train data: number of observations for each class</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">High</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">No</td>
<td style="text-align: right;">119</td>
</tr>
<tr class="even">
<td style="text-align: left;">Yes</td>
<td style="text-align: right;">81</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="train-model" class="level2">
<h2 class="anchored" data-anchor-id="train-model">Train model</h2>
<p>We now use the <code>tree()</code> function to fit a classification tree in order to predict <code>High</code> using all variables but <code>Sales</code> using only de train set.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tree)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>tree.mydataset<span class="ot">=</span><span class="fu">tree</span>(High<span class="sc">~</span>.<span class="sc">-</span>Sales, mydataset,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">subset=</span>train, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">split=</span><span class="st">"deviance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!-- We might have also used `rpart` to build the tree -->
<!-- ```{r} -->
<!-- tree.mydataset2=rpart::rpart(High~.-Sales, mydataset, subset=train) -->
<!-- ``` -->
<p>The <code>summary()</code> function lists the variables that are used as internal nodes in the tree, the number of terminal nodes, and the <strong>training</strong> error rate</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tree.mydataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Classification tree:
tree(formula = High ~ . - Sales, data = mydataset, subset = train, 
    split = "deviance")
Variables actually used in tree construction:
[1] "Price"       "Population"  "ShelveLoc"   "Age"         "Education"  
[6] "CompPrice"   "Advertising" "Income"      "US"         
Number of terminal nodes:  21 
Residual mean deviance:  0.5543 = 99.22 / 179 
Misclassification error rate: 0.115 = 23 / 200 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(tree.mydataset2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For classification trees the deviance of a tree (roughly equivalent to the concept of impurity) is defined as the sum over all terminal leaves of: <span class="math display">\[
-2 \sum_m \sum_k n_{mk} log(\hat{p}_{mk}),
\]</span></p>
<p>where <span class="math inline">\(n_{mk}\)</span> is the number of observations in the <code>m</code>th terminal node that belong to the <code>k</code>th class.</p>
<p>The <em>residual mean deviance</em> reported is simply the deviance divided by <span class="math inline">\(n - |T_0|\)</span> where <span class="math inline">\(T_0\)</span> is the number of terminal nodes.</p>
</section>
<section id="plot-the-tree" class="level2">
<h2 class="anchored" data-anchor-id="plot-the-tree">Plot the Tree</h2>
<p>The next step is display the tree graphically. We use the <code>plot()</code> function to display the tree structure, and the <code>text()</code>function to display the node labels.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tree.mydataset)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(tree.mydataset,<span class="at">pretty=</span><span class="dv">0</span>, <span class="at">cex=</span><span class="fl">0.6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/plotTree1-1.png" class="img-fluid figure-img" width="1152"></p>
<figcaption>Classification tree</figcaption>
</figure>
</div>
</div>
</div>
<p>It is also possible to show a <code>R</code> print output corresponding to each branch of the tree.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>tree.mydataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>node), split, n, deviance, yval, (yprob)
      * denotes terminal node

  1) root 200 270.000 No ( 0.59500 0.40500 )  
    2) Price &lt; 96.5 40  47.050 Yes ( 0.27500 0.72500 )  
      4) Population &lt; 414 31  40.320 Yes ( 0.35484 0.64516 )  
        8) ShelveLoc: Bad,Medium 25  34.300 Yes ( 0.44000 0.56000 )  
         16) Age &lt; 64.5 17  20.600 Yes ( 0.29412 0.70588 )  
           32) Education &lt; 13.5 7   0.000 Yes ( 0.00000 1.00000 ) *
           33) Education &gt; 13.5 10  13.860 Yes ( 0.50000 0.50000 )  
             66) Education &lt; 16.5 5   5.004 No ( 0.80000 0.20000 ) *
             67) Education &gt; 16.5 5   5.004 Yes ( 0.20000 0.80000 ) *
         17) Age &gt; 64.5 8   8.997 No ( 0.75000 0.25000 ) *
        9) ShelveLoc: Good 6   0.000 Yes ( 0.00000 1.00000 ) *
      5) Population &gt; 414 9   0.000 Yes ( 0.00000 1.00000 ) *
    3) Price &gt; 96.5 160 201.800 No ( 0.67500 0.32500 )  
      6) ShelveLoc: Bad,Medium 135 154.500 No ( 0.74074 0.25926 )  
       12) Price &lt; 124.5 82 107.700 No ( 0.63415 0.36585 )  
         24) Age &lt; 49.5 34  45.230 Yes ( 0.38235 0.61765 )  
           48) CompPrice &lt; 130.5 21  28.680 No ( 0.57143 0.42857 )  
             96) Population &lt; 134.5 6   0.000 No ( 1.00000 0.00000 ) *
             97) Population &gt; 134.5 15  20.190 Yes ( 0.40000 0.60000 )  
              194) Population &lt; 343 7   5.742 Yes ( 0.14286 0.85714 ) *
              195) Population &gt; 343 8  10.590 No ( 0.62500 0.37500 ) *
           49) CompPrice &gt; 130.5 13   7.051 Yes ( 0.07692 0.92308 ) *
         25) Age &gt; 49.5 48  46.330 No ( 0.81250 0.18750 )  
           50) CompPrice &lt; 124.5 28  14.410 No ( 0.92857 0.07143 )  
            100) Price &lt; 101.5 8   8.997 No ( 0.75000 0.25000 ) *
            101) Price &gt; 101.5 20   0.000 No ( 1.00000 0.00000 ) *
           51) CompPrice &gt; 124.5 20  25.900 No ( 0.65000 0.35000 )  
            102) Price &lt; 119 14  19.410 No ( 0.50000 0.50000 )  
              204) Advertising &lt; 10.5 9  11.460 No ( 0.66667 0.33333 ) *
              205) Advertising &gt; 10.5 5   5.004 Yes ( 0.20000 0.80000 ) *
            103) Price &gt; 119 6   0.000 No ( 1.00000 0.00000 ) *
       13) Price &gt; 124.5 53  33.120 No ( 0.90566 0.09434 )  
         26) Population &lt; 393.5 34   0.000 No ( 1.00000 0.00000 ) *
         27) Population &gt; 393.5 19  21.900 No ( 0.73684 0.26316 )  
           54) CompPrice &lt; 143.5 13   7.051 No ( 0.92308 0.07692 ) *
           55) CompPrice &gt; 143.5 6   7.638 Yes ( 0.33333 0.66667 ) *
      7) ShelveLoc: Good 25  31.340 Yes ( 0.32000 0.68000 )  
       14) Income &lt; 43 7   8.376 No ( 0.71429 0.28571 ) *
       15) Income &gt; 43 18  16.220 Yes ( 0.16667 0.83333 )  
         30) US: No 6   8.318 Yes ( 0.50000 0.50000 ) *
         31) US: Yes 12   0.000 Yes ( 0.00000 1.00000 ) *</code></pre>
</div>
</div>
</section>
<section id="prediction" class="level2">
<h2 class="anchored" data-anchor-id="prediction">Prediction</h2>
<p>In order to properly evaluate the performance of a classification tree on these data, we must estimate the test error rather than simply computing the training error.</p>
<p>We have split the observations into a training set and a test set, and the tree has been built using the training set.</p>
<p>After this, the tree performance <em>is evaluated on the test data</em>. The <code>predict()</code> function can be used for this purpose.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>tree.pred<span class="ot">=</span><span class="fu">predict</span>(tree.mydataset,mydataset.test,<span class="at">type=</span><span class="st">"class"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">table</span>(tree.pred,High.test)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         High.test
tree.pred  No Yes
      No  104  33
      Yes  13  50</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>accrcy <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">diag</span>(res)<span class="sc">/</span><span class="fu">sum</span>(res))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The accuracy is <strong>0.77</strong> or misclassification error rate is <strong>0.23</strong>, which are respectively smaller and biiger than those computed from the tree built on the train data.</p>
</section>
<section id="pruning-the-tree-tunning-model" class="level2">
<h2 class="anchored" data-anchor-id="pruning-the-tree-tunning-model">Pruning the tree (Tunning model)</h2>
<p>We know there is a chance that fitting the tree produces some overfitting so we can consider whether <em>pruning the tree</em> could lead to improved results.</p>
<p>The function <code>cv.tree()</code> performs cross-validation in order to determine the optimal level of tree complexity. - Cost complexity pruning is used in order to select a sequence of trees for consideration. - We use the argument <code>FUN = prune.misclass</code> in order to indicate that we want the classification error rate to guide the cross-validation and pruning process, rather than the default for the <code>cv.tree()</code> function, which is deviance.</p>
<p>The <code>cv.tree()</code> function reports the number of terminal nodes of each tree considered (size) as well as the corresponding error rate and the value of the cost-complexity parameter used</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123987</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>cv.mydataset<span class="ot">=</span><span class="fu">cv.tree</span>(tree.mydataset,<span class="at">FUN=</span>prune.misclass)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(cv.mydataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "size"   "dev"    "k"      "method"</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>cv.mydataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$size
[1] 21 19 14  9  8  5  3  2  1

$dev
[1] 82 80 78 78 78 76 76 84 82

$k
[1] -Inf  0.0  1.0  1.4  2.0  3.0  4.0  9.0 18.0

$method
[1] "misclass"

attr(,"class")
[1] "prune"         "tree.sequence"</code></pre>
</div>
</div>
<p>Note that, despite the name, <code>dev</code> corresponds to the cross-validation error rate in this instance.</p>
<p>The output shows how, as the size of the tree increases, so does the deviance.</p>
<p>This can be better visualized by plotting the error rate as a function of <code>size</code>and <code>k</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv.mydataset<span class="sc">$</span>size,cv.mydataset<span class="sc">$</span>dev,<span class="at">type=</span><span class="st">"b"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv.mydataset<span class="sc">$</span>k,cv.mydataset<span class="sc">$</span>dev,<span class="at">type=</span><span class="st">"b"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/errorRatePlot-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>These plots can be used to suggest the best tree, but it can also be chosen automatically by taking the minimal value <span class="math inline">\(k\)</span> from the output of the <code>cv.tree</code> function.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>myBest <span class="ot">&lt;-</span> cv.mydataset<span class="sc">$</span>size[<span class="fu">which.min</span>(cv.mydataset<span class="sc">$</span>dev)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now, the <code>prune.misclass()</code> function can be used to prune the tree and obtain a “best tree”. If <em>we decide to call the best tree the one that has reached the smallest deviance</em> we can proceed as follows:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>prune.mydataset<span class="ot">=</span><span class="fu">prune.misclass</span>(tree.mydataset,<span class="at">best=</span>myBest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(prune.mydataset)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(prune.mydataset,<span class="at">pretty=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/plotPrunedTree-1.png" class="img-fluid figure-img" width="1152"></p>
<figcaption>The best classification pruned tree</figcaption>
</figure>
</div>
</div>
</div>
<p>The tree is clearly smaller than the original one, but how well does this pruned tree perform on the test data set?</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>prunedTree.pred<span class="ot">=</span><span class="fu">predict</span>(prune.mydataset,mydataset.test,<span class="at">type=</span><span class="st">"class"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>prunedRes <span class="ot">&lt;-</span> <span class="fu">table</span>(prunedTree.pred,High.test)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>prunedRes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>               High.test
prunedTree.pred No Yes
            No  82  16
            Yes 35  67</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>prunedAccrcy <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">diag</span>(prunedRes)<span class="sc">/</span><span class="fu">sum</span>(prunedRes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The accuracy is <strong>0.745</strong>.</p>
<p>If we increase the value of <code>best</code>, for example 21 terminal nodes, we obtain a larger pruned tree with lower classification accuracy:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>prune.mydataset<span class="ot">=</span><span class="fu">prune.misclass</span>(tree.mydataset, </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">best =</span> cv.mydataset<span class="sc">$</span>size[<span class="dv">1</span>])</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(prune.mydataset)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(prune.mydataset, <span class="at">pretty=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/prunedTree2-1.png" class="img-fluid figure-img" width="1152"></p>
<figcaption>Other classification pruned tree</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>ptree.pred<span class="ot">=</span><span class="fu">predict</span>(prune.mydataset, mydataset.test, <span class="at">type=</span><span class="st">"class"</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>pres <span class="ot">&lt;-</span> <span class="fu">table</span>(ptree.pred, High.test)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>pres</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          High.test
ptree.pred  No Yes
       No  104  31
       Yes  13  52</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>paccrcy <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">diag</span>(pres)<span class="sc">/</span><span class="fu">sum</span>(pres))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The accuracy is <strong>0.78</strong>.</p>
<p><strong>In conclusion</strong> It can be seen that the difference in accuracy between the pruned tree and the original one is small. Indeed, changing the seed for splitting can lead to both smaller or bigger accuracy in the pruned tree than in the original one.</p>
<p>Obviously, the pruned tree is smaller so even if the original tree is slightly more accurate than the pruned one we might prefer the second one, because it is relying on less data to produce almost the same accuracy, whic is <em>something that most users usually prefer</em>.</p>
</section>
<section id="predicting-car-sales-with-regression-trees" class="level2">
<h2 class="anchored" data-anchor-id="predicting-car-sales-with-regression-trees">Predicting car sales with <em>regression</em> trees</h2>
<p>A reasonable question is how would the accuracy of the trees be affected if, instead of categorizing sales we had used it “as.is”, building a regression tree instead.</p>
<p>Although it may seem straightforward to answer this question by building a regression tree using the approach described in next section, the fact is that it is no so immediate as it may seem.</p>
<p>The reason for this is that, if we wish to compare the perfomance of both approaches we need a common measure of accuracy. For regression trees the Mean Square Error is generally used, while accuracy or some other measures derived from the confusion matrix are common for classification trees. <strong>Comparing those two measures, however, is not straightforward</strong>. One may think of relying on some kind of information measure, that can be computed on both regresion and classification trees such as entropy or Kullback-Leiber divergence, but the problem then is how to derive such measure for both the classification and the regression trees.</p>
</section>
</section>
<section id="regression-trees-predicting-numerical-response-variables" class="level1">
<h1>Regression Trees: Predicting numerical (response) variables</h1>
<section id="the-car-sales-problem-again" class="level2">
<h2 class="anchored" data-anchor-id="the-car-sales-problem-again">The Car Sales problem (again)</h2>
<p>Even if we do not aim at comparing regression and classification problems, the carseats problem proivides a good example on how to build and optimize a regression tree.</p>
<p>Remember our goal is to predict car sales from a simulated data set containing sales of child car seats at different stores <span class="citation" data-cites="james2013introduction">(<a href="#ref-james2013introduction" role="doc-biblioref">James et al. 2013</a>)</span>. In order to make sections reproducible, we reload the package and the data.</p>
<section id="get-the-data" class="level3">
<h3 class="anchored" data-anchor-id="get-the-data">Get the Data</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ISLR2)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Carseats"</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>mydataset <span class="ot">&lt;-</span> Carseats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="create-tarintest-sets" class="level3">
<h3 class="anchored" data-anchor-id="create-tarintest-sets">Create tarin/test sets</h3>
<p>We split original data into test and training sets. Package <code>resample</code> allows to do a weighted splitting to enbsure that no class is underrepresented due to chance. If sample size is high this can usually be ignored.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the data into training and test sets</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>pt <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mydataset), pt <span class="sc">*</span> <span class="fu">nrow</span>(mydataset))</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>mydataset.test <span class="ot">&lt;-</span> mydataset[<span class="sc">-</span>train,]</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>sales.test <span class="ot">&lt;-</span> mydataset<span class="sc">$</span>Sales[<span class="sc">-</span>train]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="build-and-check-the-model" class="level3">
<h3 class="anchored" data-anchor-id="build-and-check-the-model">Build (and check) the model</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the regression tree using the Sales variable</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>tree.mydataset <span class="ot">&lt;-</span> <span class="fu">tree</span>(Sales <span class="sc">~</span> . , mydataset,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">subset =</span> train)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of the fitted regression tree</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tree.mydataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression tree:
tree(formula = Sales ~ ., data = mydataset, subset = train)
Variables actually used in tree construction:
[1] "Price"       "ShelveLoc"   "CompPrice"   "Age"         "Advertising"
[6] "Population" 
Number of terminal nodes:  14 
Residual mean deviance:  2.602 = 484 / 186 
Distribution of residuals:
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-4.71700 -1.08700 -0.01026  0.00000  1.11300  4.06600 </code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the regression tree</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tree.mydataset)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(tree.mydataset, <span class="at">pretty =</span> <span class="dv">0</span>, <span class="at">cex =</span> <span class="fl">0.6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/plotRegTree1-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="make-prediction" class="level3">
<h3 class="anchored" data-anchor-id="make-prediction">Make prediction</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict using the test data</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>tree.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(tree.mydataset, mydataset.test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="estimate-prediction-error" class="level3">
<h3 class="anchored" data-anchor-id="estimate-prediction-error">Estimate prediction error</h3>
<p>A common measure of prediction error is the Mean Square Error.</p>
<p>Notice that it is computed from a direct substraction between the predicted sales and the original values in the test subset.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>mse1 <span class="ot">&lt;-</span> <span class="fu">mean</span>((tree.pred <span class="sc">-</span> sales.test)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>mse1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.471569</code></pre>
</div>
</div>
<p>The mean squared error obtained from the original tree is <code>4.4715694</code>.</p>
</section>
<section id="optimize-the-tree" class="level3">
<h3 class="anchored" data-anchor-id="optimize-the-tree">Optimize the tree</h3>
<p>In order to optimize the trune we first compute the best cost-complexity parameter using cross-validation and then use it to prune the tree.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prune the regression tree</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123987</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>cv.mydataset <span class="ot">&lt;-</span> <span class="fu">cv.tree</span>(tree.mydataset, <span class="at">FUN =</span> prune.tree)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(cv.mydataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "size"   "dev"    "k"      "method"</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>cv.mydataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$size
 [1] 14 13 12 11 10  9  8  7  6  4  3  2  1

$dev
 [1] 1146.347 1178.392 1178.275 1201.676 1239.316 1217.896 1242.089 1253.068
 [9] 1202.806 1211.749 1206.363 1295.017 1578.720

$k
 [1]      -Inf  16.92509  19.38585  23.44178  29.89370  36.28493  50.16562
 [8]  54.84825  65.75957  80.79945  90.11022 179.77305 277.78708

$method
[1] "deviance"

attr(,"class")
[1] "prune"         "tree.sequence"</code></pre>
</div>
</div>
<p>Before selecting the best <span class="math inline">\(\alpha\)</span> value it may be useful to plot the MSE as a function of the tree size or of <span class="math inline">\(\alpha\)</span> itself. <strong>Notice that <span class="math inline">\(\alpha\)</span> is named as “<span class="math inline">\(k\)</span>” in the <code>tree</code> package.</strong></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the cross-validation error</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv.mydataset<span class="sc">$</span>size, cv.mydataset<span class="sc">$</span>dev, <span class="at">type =</span> <span class="st">"b"</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv.mydataset<span class="sc">$</span>k, cv.mydataset<span class="sc">$</span>dev, <span class="at">type =</span> <span class="st">"b"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/costComplexityPlot-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>It seems clear that, in this case, the smallest error is attained when the tree is not pruned (size=14), so the “best” value of <span class="math inline">\(\alpha\)</span> leads to not pruning the tree.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose the best tree size</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>myBest <span class="ot">&lt;-</span> cv.mydataset<span class="sc">$</span>size[<span class="fu">which.min</span>(cv.mydataset<span class="sc">$</span>dev)]</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prune the tree with the best size</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>prune.mydataset <span class="ot">&lt;-</span> <span class="fu">prune.tree</span>(tree.mydataset, </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">best =</span> myBest)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the pruned regression tree</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(prune.mydataset)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(prune.mydataset, <span class="at">pretty =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/costComplexityChoose-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict using the pruned tree</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>prunedTree.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(prune.mydataset, mydataset.test)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean squared error for pruned tree</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>prunedMSE <span class="ot">&lt;-</span> <span class="fu">mean</span>((prunedTree.pred <span class="sc">-</span> sales.test)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>prunedMSE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.471569</code></pre>
</div>
</div>
<p>In this case, pruning does not improve the tree and the best tree is the one returned by the initial tun of the algorithm.</p>
<p>If however, we look for a compromise between the tree size and the deviance we can choose, based on the cv plots, a size of 6 or even 3:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prune the tree with the best size</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>pruneto5.mydataset <span class="ot">&lt;-</span> <span class="fu">prune.tree</span>(tree.mydataset, </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">best =</span> <span class="dv">6</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the pruned regression tree</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pruneto5.mydataset)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(pruneto5.mydataset, <span class="at">pretty =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/pruneto5-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict using the pruned tree</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>prunedTree5.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(pruneto5.mydataset, mydataset.test)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean squared error for pruned tree</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>prunedMSE5 <span class="ot">&lt;-</span> <span class="fu">mean</span>((prunedTree5.pred <span class="sc">-</span> sales.test)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>prunedMSE5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5.001169</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prune the tree with the best size</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>pruneto3.mydataset <span class="ot">&lt;-</span> <span class="fu">prune.tree</span>(tree.mydataset, </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">best =</span> <span class="dv">3</span>)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the pruned regression tree</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pruneto3.mydataset)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(pruneto3.mydataset, <span class="at">pretty =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/pruneto3-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict using the pruned tree</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>prunedTree3.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(pruneto3.mydataset, mydataset.test)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean squared error for pruned tree</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>prunedMSE3 <span class="ot">&lt;-</span> <span class="fu">mean</span>((prunedTree3.pred <span class="sc">-</span> sales.test)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>prunedMSE3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.555128</code></pre>
</div>
</div>
<p>Clearly, <em>the best compromise seems to prune with a size of 5, which hardly increases the MSE while providinga good simplification of the tree</em></p>
</section>
</section>
<section id="predicting-boston-house-prices" class="level2">
<h2 class="anchored" data-anchor-id="predicting-boston-house-prices">Predicting Boston house prices</h2>
<p>This example is borrowed from <span class="citation" data-cites="amat2017">(<a href="#ref-amat2017" role="doc-biblioref">Rodrigo 2017</a>)</span>.</p>
<p>The <code>Boston</code> dataset available in the <code>MASS</code> package contains housing prices for the city of Boston, as well as socioeconomic information for the neighborhood in which they are located.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ISLR2)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Boston"</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>datos <span class="ot">&lt;-</span> Boston</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(datos, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     crim zn indus chas   nox    rm  age    dis rad tax ptratio lstat medv
1 0.00632 18  2.31    0 0.538 6.575 65.2 4.0900   1 296    15.3  4.98 24.0
2 0.02731  0  7.07    0 0.469 6.421 78.9 4.9671   2 242    17.8  9.14 21.6
3 0.02729  0  7.07    0 0.469 7.185 61.1 4.9671   2 242    17.8  4.03 34.7</code></pre>
</div>
</div>
<p>Our goal is to fit a regression model that allows predicting the average price of a home (<code>medv</code>) based on the available variables.</p>
<p>A quick visualization of the available variables shows that, not only they are of mixed types, but also the relation between them is far from linear inmost if not all cases.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>color <span class="ot">&lt;-</span> <span class="fu">adjustcolor</span>(<span class="st">"forestgreen"</span>, <span class="at">alpha.f =</span> <span class="fl">0.5</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>ps <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, ...) {  <span class="co"># custom panel function</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">panel.smooth</span>(x, y, <span class="at">col =</span> color, <span class="at">col.smooth =</span> <span class="st">"black"</span>, </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">cex =</span> <span class="fl">0.7</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>nc<span class="ot">&lt;-</span> <span class="fu">ncol</span>(datos)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(datos[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,nc)], <span class="at">cex =</span> <span class="fl">0.7</span>, <span class="at">upper.panel =</span> ps, <span class="at">col =</span> color)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/BostonPlotVars-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="768"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pairs(datos[,c(7:14)], cex = 0.7, upper.panel = ps, col = color)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This is a good scenario to consider regression trees as a good option.</p>
<section id="model-fitting" class="level3">
<h3 class="anchored" data-anchor-id="model-fitting">Model fitting</h3>
<p>Create a train and test sets</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(datos), <span class="at">size =</span> <span class="fu">nrow</span>(datos)<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>datos_train <span class="ot">&lt;-</span> datos[train,]</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>datos_test  <span class="ot">&lt;-</span> datos[<span class="sc">-</span>train,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We use the <code>tree</code> function of the <code>tree</code> package to build the model. This function grows the tree until it meets a stop condition. By default, these conditions are:</p>
<ul>
<li><code>mincut</code>: minimum number of observations that at least one of the child nodes must have for the division to occur.</li>
<li><code>minsize</code>: minimum number of observations a node must have in order for it to be split.</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>regTree<span class="ot">&lt;-</span> tree<span class="sc">::</span><span class="fu">tree</span>(</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">formula =</span> medv <span class="sc">~</span> .,</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data    =</span> datos_train,</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">split   =</span> <span class="st">"deviance"</span>,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">mincut  =</span> <span class="dv">20</span>,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">minsize =</span> <span class="dv">50</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>                  )</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(regTree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression tree:
tree::tree(formula = medv ~ ., data = datos_train, split = "deviance", 
    mincut = 20, minsize = 50)
Variables actually used in tree construction:
[1] "rm"    "lstat" "dis"   "tax"  
Number of terminal nodes:  6 
Residual mean deviance:  20.56 = 5078 / 247 
Distribution of residuals:
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-14.5500  -2.8680  -0.3628   0.0000   2.0050  22.1300 </code></pre>
</div>
</div>
<p>The <code>summary</code> shows that the trained tree has a total of 6 terminal nodes and that the variables <code>rm, lstat, dis</code> and <code>tax</code> have been used as predictors.</p>
<p>In the context of regression trees, the <code>Residual mean deviance</code> term is the residual sum of squares divided by (number of observations - number of terminal nodes). The smaller the deviance, the better the fit of the tree to the training observations.</p>
<p>The tree can be visualized:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> regTree, <span class="at">type =</span> <span class="st">"proportional"</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x =</span> regTree, <span class="at">splits =</span> <span class="cn">TRUE</span>, <span class="at">pretty =</span> <span class="dv">0</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"firebrick"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/BostonPlotTree-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="prunning-the-tree" class="level3">
<h3 class="anchored" data-anchor-id="prunning-the-tree">Prunning the tree</h3>
<p>We use the <code>cv.tree</code> function that uses cross validation to identify the optimal penalty value. By default, this function relies on the <em>deviance</em> to guide the pruning process.</p>
<p>We <strong>grow the tree again</strong> with less restrictive parameters so we have a big tree to prune:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>regTree2<span class="ot">&lt;-</span> tree<span class="sc">::</span><span class="fu">tree</span>(</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">formula =</span> medv <span class="sc">~</span> .,</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data    =</span> datos_train,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">split   =</span> <span class="st">"deviance"</span>,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">mincut  =</span> <span class="dv">1</span>,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">minsize =</span> <span class="dv">2</span>,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">mindev  =</span> <span class="dv">0</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>                  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>cv_regTree2 <span class="ot">&lt;-</span> tree<span class="sc">::</span><span class="fu">cv.tree</span>(regTree2, <span class="at">K =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The function returns an object <code>cv_regTree2</code> containing:</p>
<ul>
<li><code>size</code>: The size (number of terminal nodes) of each tree.</li>
<li><code>dev</code>: The cross-validation test error estimate for each tree size.</li>
<li><code>k</code>: The range of penalty values <span class="math inline">\(\alpha\)</span> evaluated.</li>
<li><code>method</code>: The criteria used to select the best tree.</li>
</ul>
<p>These can be used to visualize and understand the optimization performed.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>optSize <span class="ot">&lt;-</span> <span class="fu">rev</span>(cv_regTree2<span class="sc">$</span>size)[<span class="fu">which.min</span>(<span class="fu">rev</span>(cv_regTree2<span class="sc">$</span>dev))]</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"Optimal size obtained is:"</span>, optSize)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Optimal size obtained is: 10"</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>resultados_cv <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n_nodes  =</span> cv_regTree2<span class="sc">$</span>size,</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">deviance =</span> cv_regTree2<span class="sc">$</span>dev,</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">alpha    =</span> cv_regTree2<span class="sc">$</span>k</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> resultados_cv, <span class="fu">aes</span>(<span class="at">x =</span> n_nodes, <span class="at">y =</span> deviance)) <span class="sc">+</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> optSize, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Error vs tree size"</span>) <span class="sc">+</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_bw</span>() </span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> resultados_cv, <span class="fu">aes</span>(<span class="at">x =</span> alpha, <span class="at">y =</span> deviance)) <span class="sc">+</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Error vs penalization (alpha)"</span>) <span class="sc">+</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_bw</span>() </span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(p1, p2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/BostonPlotAlphas-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Once the optimal value identified, the final pruning is applied with the <code>prune.tree</code> function. This function also accepts the optimal value of <span class="math inline">\(\alpha\)</span> instead of size.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>finalTree <span class="ot">&lt;-</span> tree<span class="sc">::</span><span class="fu">prune.tree</span>(</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">tree =</span> regTree2,</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">best =</span> optSize</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> finalTree, <span class="at">type =</span> <span class="st">"proportional"</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x =</span> finalTree, <span class="at">splits =</span> <span class="cn">TRUE</span>, <span class="at">pretty =</span> <span class="dv">0</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"firebrick"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Decision_Trees---Lab_1_files/figure-html/BostonPruneTree-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="predicting-and-checking-model-accuracy" class="level3">
<h3 class="anchored" data-anchor-id="predicting-and-checking-model-accuracy">Predicting and checking model accuracy</h3>
<p>We can use both, original and pruned trees to predict the data for the test set.</p>
<p>The quality of the prediction is based in the Root Mean Square.</p>
<p>For the original tree one has:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>predicciones <span class="ot">&lt;-</span> <span class="fu">predict</span>(regTree, <span class="at">newdata =</span> datos_test)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>test_rmse    <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((predicciones <span class="sc">-</span> datos_test<span class="sc">$</span>medv)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"Error de test (rmse) del árbol inicial:"</span>, <span class="fu">round</span>(test_rmse,<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Error de test (rmse) del árbol inicial: 5.74"</code></pre>
</div>
</div>
<p>And for the final tree:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>predicciones_finales <span class="ot">&lt;-</span> <span class="fu">predict</span>(finalTree, <span class="at">newdata =</span> datos_test)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>test_rmse    <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((predicciones_finales <span class="sc">-</span> datos_test<span class="sc">$</span>medv)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"Error de test (rmse) del árbol final:"</span>, <span class="fu">round</span>(test_rmse,<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Error de test (rmse) del árbol final: 5.13"</code></pre>
</div>
</div>
<p>That is <em>The error associated with the prediction has slightly decreased, while the tree is much simpler</em>.</p>
<p><strong>That is what we ideal are aiming at!</strong></p>
</section>
</section>
</section>
<section id="alternative-packages-for-cart" class="level1">
<h1>Alternative packages for CART</h1>
<section id="comparison-between-caret-rpart-and-tree" class="level2">
<h2 class="anchored" data-anchor-id="comparison-between-caret-rpart-and-tree">Comparison between <code>caret</code>, <code>rpart</code>, and <code>tree</code></h2>
<p>Two popular packages for working with decision trees are <code>rpart</code> and <code>tree</code>. Both offer functionalities for building and visualizing decision trees. The table below shows a comparison between the main functions of these packages, as well as <code>caret</code>, which is a generic framework for performing classification and prediction tasks, including trees.</p>
<section id="table-comparison-of-important-functions-for-working-with-decision-trees" class="level3">
<h3 class="anchored" data-anchor-id="table-comparison-of-important-functions-for-working-with-decision-trees">Table: Comparison of important functions for working with decision trees</h3>
<table class="table">
<colgroup>
<col style="width: 21%">
<col style="width: 28%">
<col style="width: 27%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Function / Package</strong></th>
<th><strong>tree</strong></th>
<th><strong>rpart</strong></th>
<th><strong>caret</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Building Decision Tree</strong></td>
<td><strong><code>tree()</code></strong></td>
<td><strong><code>rpart()</code></strong></td>
<td><strong><code>train()</code></strong> with method = “rpart”</td>
</tr>
<tr class="even">
<td><strong>Visualizing Decision Tree</strong></td>
<td>-</td>
<td><strong><code>plot()</code></strong></td>
<td><strong><code>plot()</code></strong> with type = “text”</td>
</tr>
<tr class="odd">
<td><strong>Pruning Decision Tree</strong></td>
<td><strong><code>cv.tree()</code></strong></td>
<td><strong><code>prune()</code></strong></td>
<td><strong><code>train()</code></strong> with method = “rpart” and tuneLength &gt; 1</td>
</tr>
<tr class="even">
<td><strong>Evaluating Model Performance</strong></td>
<td>-</td>
<td><strong><code>predict()</code></strong></td>
<td><strong><code>train()</code></strong> with method = “rpart” and metric = “Accuracy”</td>
</tr>
<tr class="odd">
<td><strong>Handling Missing Values</strong></td>
<td><strong><code>na.action</code></strong></td>
<td><strong><code>na.action</code></strong></td>
<td><strong><code>preProcess()</code></strong> with method = “medianImpute”</td>
</tr>
<tr class="even">
<td><strong>Tuning Hyperparameters</strong></td>
<td>-</td>
<td><strong><code>rpart.control()</code></strong></td>
<td><strong><code>train()</code></strong> with method = “rpart” and tuneGrid argument</td>
</tr>
<tr class="odd">
<td><strong>Visualizing Variable Importance</strong></td>
<td>-</td>
<td><strong><code>importance()</code></strong></td>
<td><strong><code>varImp()</code></strong></td>
</tr>
</tbody>
</table>
</section>
<section id="examples-of-usage" class="level3">
<h3 class="anchored" data-anchor-id="examples-of-usage">Examples of usage:</h3>
<table class="table">
<colgroup>
<col style="width: 21%">
<col style="width: 28%">
<col style="width: 27%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Function / Package</strong></th>
<th><strong>tree</strong></th>
<th><strong>rpart</strong></th>
<th><strong>caret</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Building Decision Tree</strong></td>
<td><strong><code>tree(Species ~ ., data = iris)</code></strong></td>
<td><strong><code>rpart(Species ~ ., data = iris)</code></strong></td>
<td><strong><code>train(Species ~ ., method = "rpart", data = iris)</code></strong></td>
</tr>
<tr class="even">
<td><strong>Visualizing Decision Tree</strong></td>
<td>-</td>
<td><strong><code>plot(fit)</code></strong></td>
<td><strong><code>plot(fit, type = "text")</code></strong></td>
</tr>
<tr class="odd">
<td><strong>Pruning Decision Tree</strong></td>
<td><strong><code>cv.tree(Species ~ ., data = iris)</code></strong></td>
<td><strong><code>prune(fit, cp = 0.02)</code></strong></td>
<td><strong><code>train(Species ~ ., method = "rpart", data = iris, tuneLength = 5)</code></strong></td>
</tr>
<tr class="even">
<td><strong>Evaluating Model Performance</strong></td>
<td>-</td>
<td><strong><code>pred &lt;- predict(fit, iris, type = "class")</code></strong></td>
<td><strong><code>train(Species ~ ., method = "rpart", data = iris, metric = "Accuracy")</code></strong></td>
</tr>
<tr class="odd">
<td><strong>Handling Missing Values</strong></td>
<td><strong><code>tree(Species ~ ., data = na.omit(iris))</code></strong></td>
<td><strong><code>rpart(Species ~ ., data = na.omit(iris), na.action = na.rpart)</code></strong></td>
<td><strong><code>preProcess(iris, method = "medianImpute")</code></strong></td>
</tr>
<tr class="even">
<td><strong>Tuning Hyperparameters</strong></td>
<td>-</td>
<td><strong><code>rpart(Species ~ ., data = iris, control = rpart.control(cp = c(0.001, 0.01, 0.1)))</code></strong></td>
<td><strong><code>train(Species ~ ., method = "rpart", data = iris, tuneGrid = expand.grid(cp = c(0.001, 0.01, 0.1)))</code></strong></td>
</tr>
<tr class="odd">
<td><strong>Visualizing Variable Importance</strong></td>
<td>-</td>
<td><strong><code>importance(fit)</code></strong></td>
<td><strong><code>varImp(fit)</code></strong></td>
</tr>
</tbody>
</table>
<p>These examples illustrate how to perform various tasks related to decision trees using the <code>tree</code>, <code>rpart</code>, and <code>caret</code> packages. Each package has its own syntax and set of functions, so they can be used according to the user’s needs and preferences.</p>
</section>
</section>
</section>
<section id="exercises" class="level1">
<h1>Exercises</h1>
<p>This problem involves the <em>OJ</em> data set which is part of the ISLR2 package.</p>
<ol type="a">
<li>Create a training set containing a random sample of 800 observations, and a test set containing the remaining observations.</li>
<li>Fit a tree to the training data, with Purchase as the response and the other variables as predictors. Use the summary () function to produce summary statistics about the tree, and describe the results obtained. What is the training error rate? How many terminal nodes does the tree have?</li>
<li>Type in the name of the tree object in order to get a detailed text output. Pick one of the terminal nodes, and interpret the information displayed.</li>
<li>Create a plot of the tree, and interpret the results.</li>
<li>Predict the response on the test data, and produce a confusion matrix comparing the test labels to the predicted test labels. What is the test error rate?</li>
<li>Apply the cv.tree() function to the training set in order to determine the optimal tree size.</li>
<li>Produce a plot with tree size on the <span class="math inline">\(x\)</span>-axis and cross-validated classification error rate on the <span class="math inline">\(y\)</span>-axis.</li>
<li>Which tree size corresponds to the lowest cross-validated classification error rate?</li>
<li>Produce a pruned tree corresponding to the optimal tree size obtained using cross-validation. If cross-validation does not lead to selection of a pruned tree, then create a pruned tree with five terminal nodes.</li>
<li>Compare the training error rates between the pruned and unpruned trees. Which is higher?</li>
<li>Compare the test error rates between the pruned and unpruned trees. Which is higher?</li>
</ol>
<p>Once you have solved the exercise, try to repeat it using another R package, either <code>rpàrt</code> or <code>caret</code>. Compare the results obtained and comment about the differences observed.</p>
</section>
<section id="references" class="level1 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-james2013introduction" class="csl-entry" role="listitem">
James, Gareth, Daniela Witten, Trevor Hastie, and Robert Tibshirani. 2013. <em>An Introduction to Statistical Learning</em>. Vol. 112. Springer.
</div>
<div id="ref-amat2017" class="csl-entry" role="listitem">
Rodrigo, Joaquín Amat. 2017. <span>“Arboles de Decision, Random Forest, Gradient Boosting y C5.0.”</span> <a href="https://www.cienciadedatos.net/documentos/33_arboles_de_prediccion_bagging_random_forest_boosting#Introducci%C3%B3n">https://www.cienciadedatos.net/documentos/33_arboles_de_prediccion_bagging_random_forest_boosting#Introducci%C3%B3n</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>